<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}?v={{ timestamp }}">
</head>
<body>
    <!-- Compact Mode Toggle Button -->
    <button id="compactToggle" class="compact-toggle-btn" title="Toggle Compact Mode">
        <i class="fas fa-compress"></i>
    </button>
    <!-- Settings button removed (deprecated global settings page) -->

    <div class="container py-3">
        <div class="title-container text-center mb-1">
            <div class="d-flex align-items-center justify-content-center gap-2">
                <div class="title-logo-small">
                    <img src="{{ url_for('static', filename='ollama-logo.png') }}" alt="Ollama">
                </div>
                <h2 class="page-title-minimal mb-0">Ollama Dashboard</h2>
                {% if ollama_version != 'Unknown' %}
                <small class="text-muted fw-light ms-2">v{{ ollama_version }}</small>
                {% endif %}
            </div>
        </div>

        <div class="refresh-indicator mb-2 {% if error %}error{% endif %} d-flex align-items-center gap-2" data-timezone="{{ timezone }}" data-poll-interval="5">
            <div class="dot"></div>
            <span>Last updated: <span id="lastUpdate"></span> • Next refresh in <span id="nextRefresh">5</span>s</span>
            <button type="button" class="btn btn-sm btn-outline-secondary btn-refresh" id="refreshDashboardBtn" title="Refresh dashboard data" onclick="refreshDashboardData()" aria-label="Refresh">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>

        <!-- Restart confirmation modal -->
        <div class="modal fade" id="restartConfirmModal" tabindex="-1" aria-labelledby="restartConfirmModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content bg-dark text-light">
                    <div class="modal-header">
                        <h5 class="modal-title" id="restartConfirmModalLabel">Confirm Restart</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Restarting the Ollama service will stop and start background processes. This may interrupt running models and ongoing requests. Are you sure you want to proceed?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button id="confirmRestartBtn" type="button" class="btn btn-warning">Restart Ollama</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Health Status Indicator and Service Controls -->
        <div class="d-flex justify-content-center mb-2 align-items-center gap-2">
            <div id="healthStatus" class="badge bg-secondary health-status-badge">
                <i class="fas fa-heartbeat me-2"></i>
                <span id="healthText">Checking health...</span>
            </div>
            <div class="service-controls d-flex gap-2 align-items-center">
                <button id="startServiceBtn" class="btn btn-sm btn-success" title="Start Ollama service" onclick="startOllamaService()">
                    <i class="fas fa-play"></i>
                </button>
                <button id="stopServiceBtn" class="btn btn-sm btn-secondary" title="Stop Ollama service" onclick="stopOllamaService()">
                    <i class="fas fa-stop"></i>
                </button>
                <button id="restartServiceBtn" class="btn btn-sm btn-warning" title="Restart Ollama service" onclick="showRestartConfirm()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- Models Management Section -->
        <div class="models-section">
                <!-- Compact System Resources -->
                <div class="compact-system-resources mb-2">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-server text-primary section-icon"></i>
                            <span class="fw-semibold text-light section-title-text">System Resources</span>
                        </div>
                        <small class="text-muted last-update-time" id="lastUpdateTime">Updated just now</small>
                    </div>



                    <div class="compact-metrics-grid">
                        <!-- CPU -->
                        <div class="compact-metric">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center gap-1">
                                    <i class="fas fa-microchip resource-icon resource-icon-cpu"></i>
                                    <span class="metric-label-compact">CPU</span>
                                </div>
                                    <span class="metric-value-compact" id="cpuPercent">{{ system_stats.cpu_percent|round(1) }}%</span>
                            </div>
                            <canvas class="timeline-canvas" id="cpuTimeline" width="200" height="20"></canvas>
                        </div>

                        <!-- RAM -->
                        <div class="compact-metric">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center gap-1">
                                    <i class="fas fa-memory resource-icon resource-icon-ram"></i>
                                    <span class="metric-label-compact">RAM</span>
                                </div>
                                <span class="metric-value-compact" id="memoryPercent">{{ system_stats.memory.percent|round(1) }}%</span>
                            </div>
                            <canvas class="timeline-canvas" id="memoryTimeline" width="200" height="20"></canvas>
                        </div>

                        <!-- VRAM -->
                        <div class="compact-metric">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center gap-1">
                                    <i class="fas fa-palette resource-icon resource-icon-gpu"></i>
                                    <span class="metric-label-compact">VRAM</span>
                                </div>
                                <span class="metric-value-compact" id="vramPercent">{{ system_stats.vram.percent|round(1) if system_stats.vram is defined and system_stats.vram.total is defined and system_stats.vram.total > 0 else '--' }}%</span>
                            </div>
                            <canvas class="timeline-canvas" id="vramTimeline" width="200" height="20"></canvas>
                        </div>

                        <!-- Disk -->
                        <div class="compact-metric">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center gap-1">
                                    <i class="fas fa-hdd resource-icon resource-icon-disk"></i>
                                    <span class="metric-label-compact">Disk</span>
                                </div>
                                <span class="metric-value-compact" id="diskPercent">{{ system_stats.disk.percent|round(1) }}%</span>
                            </div>
                            <canvas class="timeline-canvas" id="diskTimeline" width="200" height="20"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Models Management Section -->
                <div class="models-management mt-4">
                    <!-- Running Models -->
                    {% if models %}
                    <div class="mb-4">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="d-flex align-items-center gap-2">
                                <i class="fas fa-play-circle text-success section-icon"></i>
                                <span class="fw-semibold text-light section-title-text">Running Models</span>
                                <span class="badge bg-primary text-white ms-2" id="runningModelsCount">{{ models|length }}</span>
                            </div>
                            {% if models %}
                            <div class="capability-filters d-flex gap-1" id="runningModelsFilters">
                                <button class="btn btn-sm btn-outline-secondary filter-btn active" data-capability="reasoning" title="Toggle Reasoning" onclick="toggleCapabilityFilter('reasoning')">
                                    <i class="fas fa-brain"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary filter-btn active" data-capability="vision" title="Toggle Vision" onclick="toggleCapabilityFilter('vision')">
                                    <i class="fas fa-image"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary filter-btn active" data-capability="tools" title="Toggle Tool Usage" onclick="toggleCapabilityFilter('tools')">
                                    <i class="fas fa-tools"></i>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        <div class="row g-3" id="runningModelsContainer">
                            {% for model in models %}
                            <div class="col-md-6 col-lg-4">
                                <div class="model-card h-100" data-model-name="{{ model.name|e }}">
                                    <div class="model-header">
                                        <div class="model-icon-wrapper">
                                            <i class="fas fa-brain model-icon-main"></i>
                                        </div>
                                        <div class="model-meta">
                                            <span class="status-indicator running">
                                                <i class="fas fa-circle"></i>Running
                                            </span>
                                        </div>
                                    </div>
                                    <div class="model-title">{{ model.name }}
                                        {% if model.has_custom_settings %}
                                        <span class="badge bg-info text-dark ms-2" title="Custom settings configured">⚙️</span>
                                        {% endif %}
                                    </div>
                                    <div class="model-capabilities">
                                        <span class="capability-icon {{ 'enabled' if model.has_reasoning is true else ('disabled' if model.has_reasoning is false else 'unknown') }}" title="Reasoning: {{ 'Available' if model.has_reasoning is true else ('Not available' if model.has_reasoning is false else 'Unknown') }}">
                                            <i class="fas fa-brain"></i>
                                        </span>
                                        <span class="capability-icon {{ 'enabled' if model.has_vision is true else ('disabled' if model.has_vision is false else 'unknown') }}" title="Image Processing: {{ 'Available' if model.has_vision is true else ('Not available' if model.has_vision is false else 'Unknown') }}">
                                            <i class="fas fa-image"></i>
                                        </span>
                                        <span class="capability-icon {{ 'enabled' if model.has_tools is true else ('disabled' if model.has_tools is false else 'unknown') }}" title="Tool Usage: {{ 'Available' if model.has_tools is true else ('Not available' if model.has_tools is false else 'Unknown') }}">
                                            <i class="fas fa-tools"></i>
                                        </span>
                                    </div>
                                    <div class="model-specs">
                                        <div class="spec-row compact-hide">
                                            <div class="spec-item">
                                                <div class="spec-icon">
                                                    <i class="fas fa-cogs"></i>
                                                </div>
                                                <div class="spec-content">
                                                    <div class="spec-label">Family</div>
                                                    <div class="spec-value">{{ model.details.family if model.details is defined and model.details.family is defined else 'Unknown' }}</div>
                                                </div>
                                            </div>
                                            <div class="spec-item">
                                                <div class="spec-icon">
                                                    <i class="fas fa-weight"></i>
                                                </div>
                                                <div class="spec-content">
                                                    <div class="spec-label">Parameters</div>
                                                    <div class="spec-value">{{ model.parameter_size|default('Unknown') }}</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="spec-row compact-hide">
                                            <div class="spec-item">
                                                <div class="spec-icon">
                                                    <i class="fas fa-hdd"></i>
                                                </div>
                                                <div class="spec-content">
                                                    <div class="spec-label">Size</div>
                                                    <div class="spec-value text-nowrap">{{ model.formatted_size|default(model.size|default('Unknown')) }}</div>
                                                </div>
                                            </div>
                                            <div class="spec-item">
                                                <div class="spec-icon">
                                                    <i class="fas fa-microchip"></i>
                                                </div>
                                                <div class="spec-content">
                                                    <div class="spec-label text-nowrap">GPU Allocation</div>
                                                    <div class="spec-value text-nowrap" id="model-gpu-{{ loop.index }}">
                                                        {% if model.size_vram is defined and model.size is defined and model.size > 0 %}
                                                            {{ (model.size_vram / model.size * 100)|round(1) }}% ({{ model.formatted_size_vram|default('0 B') }})
                                                        {% else %}
                                                            0% (0 B)
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="spec-row compact-hide">
                                            <div class="spec-item">
                                                <div class="spec-icon">
                                                    <i class="fas fa-align-left"></i>
                                                </div>
                                                <div class="spec-content">
                                                    <div class="spec-label">Context</div>
                                                    <div class="spec-value" id="model-context-{{ loop.index }}">{{ model.context_length|default('Unknown') }}</div>
                                                </div>
                                            </div>
                                            <div class="spec-item opacity-0">
                                                <div class="spec-content">
                                                    <div class="spec-label">&nbsp;</div>
                                                    <div class="spec-value">&nbsp;</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="model-actions">
                                        <button class="btn btn-info" onclick="showModelInfo(this.closest('.model-card').dataset.modelName)" title="View model information">
                                            <i class="fas fa-info-circle"></i> <span class="d-none d-sm-inline">Info</span>
                                        </button>
                                        <button class="btn btn-secondary" onclick="openModelSettingsModal(this.closest('.model-card').dataset.modelName)" title="Settings">
                                            <i class="fas fa-cog"></i> <span class="d-none d-sm-inline">Settings</span>
                                        </button>
                                        <button class="btn btn-primary" onclick="restartModel(this.closest('.model-card').dataset.modelName)" title="Restart model">
                                            <i class="fas fa-redo"></i> <span class="d-none d-sm-inline">Restart</span>
                                        </button>
                                        <button class="btn btn-warning" onclick="stopModel(this.closest('.model-card').dataset.modelName)" title="Stop model">
                                            <i class="fas fa-stop"></i> <span class="d-none d-sm-inline">Stop</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Available Models -->
                    {% if available_models %}
                    <div class="mb-4">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="d-flex align-items-center gap-2">
                                <i class="fas fa-box text-primary section-icon"></i>
                                <span class="fw-semibold text-light section-title-text">Available Models</span>
                                <span class="badge bg-primary text-white ms-2" id="availableModelsCount">{{ available_models|length }}</span>
                            </div>
                            <div class="d-flex align-items-center gap-3">
                                <small class="text-muted d-none d-sm-block">{{ available_models|length }} model{{ available_models|length != 1 and 's' or '' }} ready</small>
                                {% if available_models and not models %}
                                <div class="capability-filters d-flex gap-1" id="availableModelsFilters">
                                    <button class="btn btn-sm btn-outline-secondary filter-btn active" data-capability="reasoning" title="Toggle Reasoning" onclick="toggleCapabilityFilter('reasoning')">
                                        <i class="fas fa-brain"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary filter-btn active" data-capability="vision" title="Toggle Vision" onclick="toggleCapabilityFilter('vision')">
                                        <i class="fas fa-image"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary filter-btn active" data-capability="tools" title="Toggle Tool Usage" onclick="toggleCapabilityFilter('tools')">
                                        <i class="fas fa-tools"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row g-3" id="availableModelsContainer">
                            {% for model in available_models %}
                            <div class="col-md-6 col-lg-4">
                                <div class="model-card h-100" data-model-name="{{ model.name|e }}">
                                    <div class="model-header">
                                        <div class="model-icon-wrapper">
                                            <i class="fas fa-box model-icon-main"></i>
                                        </div>
                                        <div class="model-meta">
                                            <span class="status-indicator available">
                                                <i class="fas fa-circle"></i>Available
                                            </span>
                                        </div>
                                    </div>
                                    <div class="model-title">{{ model.name }}
                                        {% if model.has_custom_settings %}
                                        <span class="badge bg-info text-dark ms-2" title="Custom settings configured">⚙️</span>
                                        {% endif %}
                                    </div>
                                    <div class="model-capabilities">
                                        <span class="capability-icon {{ 'enabled' if model.has_reasoning is true else ('disabled' if model.has_reasoning is false else 'unknown') }}" title="Reasoning: {{ 'Available' if model.has_reasoning is true else ('Not available' if model.has_reasoning is false else 'Unknown') }}">
                                            <i class="fas fa-brain"></i>
                                        </span>
                                        <span class="capability-icon {{ 'enabled' if model.has_vision is true else ('disabled' if model.has_vision is false else 'unknown') }}" title="Image Processing: {{ 'Available' if model.has_vision is true else ('Not available' if model.has_vision is false else 'Unknown') }}">
                                            <i class="fas fa-image"></i>
                                        </span>
                                        <span class="capability-icon {{ 'enabled' if model.has_tools is true else ('disabled' if model.has_tools is false else 'unknown') }}" title="Tool Usage: {{ 'Available' if model.has_tools is true else ('Not available' if model.has_tools is false else 'Unknown') }}">
                                            <i class="fas fa-tools"></i>
                                        </span>
                                    </div>
                                    <div class="model-specs">
                                        <div class="spec-row compact-hide">
                                            <div class="spec-item">
                                                <div class="spec-icon">
                                                    <i class="fas fa-cogs"></i>
                                                </div>
                                                <div class="spec-content">
                                                    <div class="spec-label">Family</div>
                                                    <div class="spec-value">{{ model.details.family|default('Unknown') }}</div>
                                                </div>
                                            </div>
                                            <div class="spec-item">
                                                <div class="spec-icon">
                                                    <i class="fas fa-weight"></i>
                                                </div>
                                                <div class="spec-content">
                                                    <div class="spec-label">Parameters</div>
                                                    <div class="spec-value">{{ model.details.parameter_size if model.details is defined and model.details.parameter_size is defined else 'Unknown' }}</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="spec-row spec-row-size-context compact-hide">
                                            <div class="spec-item">
                                                <div class="spec-icon">
                                                    <i class="fas fa-hdd"></i>
                                                </div>
                                                <div class="spec-content">
                                                    <div class="spec-label">Size</div>
                                                    <div class="spec-value">{{ model.size|filesizeformat if model.size else 'Unknown' }}</div>
                                                </div>
                                            </div>
                                            <div class="spec-item">
                                                <div class="spec-icon">
                                                    <i class="fas fa-align-left"></i>
                                                </div>
                                                <div class="spec-content">
                                                    <div class="spec-label">Context</div>
                                                    <div class="spec-value">{{ model.context_length or (model.details or {}).get('context_length') or 'Unknown' }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="model-actions">
                                        <button class="btn btn-success" onclick="startModel(this.closest('.model-card').dataset.modelName)" title="Start model" aria-label="Start model">
                                            <i class="fas fa-play"></i> <span class="d-none d-sm-inline">Start</span>
                                        </button>
                                        <button class="btn btn-primary" onclick="restartModel(this.closest('.model-card').dataset.modelName)" title="Restart model" aria-label="Restart model">
                                            <i class="fas fa-redo"></i> <span class="d-none d-sm-inline">Restart</span>
                                        </button>
                                        <button class="btn btn-info" onclick="showModelInfo(this.closest('.model-card').dataset.modelName)" title="View model information" aria-label="View model information">
                                            <i class="fas fa-info-circle"></i> <span class="d-none d-sm-inline">Info</span>
                                        </button>
                                        <button class="btn btn-secondary" onclick="openModelSettingsModal(this.closest('.model-card').dataset.modelName)" title="Settings" aria-label="Settings">
                                            <i class="fas fa-cog"></i> <span class="d-none d-sm-inline">Settings</span>
                                        </button>
                                        <button class="btn btn-danger" onclick="deleteModel(this.closest('.model-card').dataset.modelName)" title="Delete model" aria-label="Delete model">
                                            <i class="fas fa-trash"></i> <span class="d-none d-sm-inline">Delete</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Downloadable Models -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="d-flex align-items-center gap-2">
                                <i class="fas fa-star text-warning section-icon"></i>
                                <span class="fw-semibold text-light section-title-text">Downloadable Models</span>
                            </div>
                            <div class="d-flex align-items-center gap-3">
                                <small class="text-muted d-none d-sm-block">Curated selection from Ollama library</small>
                                {% if not models and not available_models %}
                                <div class="capability-filters d-flex gap-1" id="bestModelsFilters">
                                    <button class="btn btn-sm btn-outline-secondary filter-btn active" data-capability="reasoning" title="Toggle Reasoning" onclick="toggleCapabilityFilter('reasoning')">
                                        <i class="fas fa-brain"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary filter-btn active" data-capability="vision" title="Toggle Vision" onclick="toggleCapabilityFilter('vision')">
                                        <i class="fas fa-image"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary filter-btn active" data-capability="tools" title="Toggle Tool Usage" onclick="toggleCapabilityFilter('tools')">
                                        <i class="fas fa-tools"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row g-3" id="downloadableModelsContainer">
                            <!-- Populated by JS -->
                            <div class="col-12 text-center py-4">
                                <div class="spinner-border text-secondary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>

                        <!-- View More Button -->
                        <div class="text-center mt-3">
                            <button id="viewMoreModelsBtn" class="btn btn-outline-secondary" onclick="toggleExtendedModels()">
                                <i class="fas fa-plus-circle me-2"></i>View More Models
                            </button>
                        </div>

                        <!-- Extended Models Container (hidden by default) -->
                        <div id="extendedModelsContainer" class="row g-3 mt-2 extended-models-container">
                            <!-- Populated by JS when expanded -->
                        </div>
                    </div>

                    <!-- No Models Message -->
                    {% if not models and not available_models %}
                    <div class="text-center py-5">
                        <i class="fas fa-brain fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Models Available</h5>
                        <p class="text-muted">No models are installed or running. Install models using Ollama CLI.</p>
                    </div>
                    {% endif %}
                </div>
        </div>

    {% if error %}
    <div class="alert alert-danger" role="alert">
        <span class="detail-icon">⚠️</span> {{ error }}
    </div>
    {% endif %}

    <script src="{{ url_for('static', filename='js/modules/utils.js') }}?v={{ timestamp }}"></script>
    <script src="{{ url_for('static', filename='js/modules/modelCards.js') }}?v={{ timestamp }}"></script>
    <script src="{{ url_for('static', filename='js/modules/serviceControl.js') }}?v={{ timestamp }}"></script>
    <script src="{{ url_for('static', filename='js/modules/settings.js') }}?v={{ timestamp }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}?v={{ timestamp }}"></script>
    <script src="{{ url_for('static', filename='js/modules/bootstrap.js') }}?v={{ timestamp }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
